services:
  minecraft-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: minecraft-server-dev
    restart: unless-stopped
    
    # Load environment variables from .env.dev
    env_file:
      - .env.dev
    
    ports:
      - "25565:25565"  # Minecraft Java Edition
      - "25575:25575"  # RCON
      - "8100:8100"    # BlueMap Web UI
      - "19132:19132/udp"  # Geyser Bedrock Edition
    
    environment:
      # Accept EULA
      EULA: "TRUE"
      
      # Server Type - Development
      TYPE: "SPIGOT"
      VERSION: "1.21.5"
      
      # Memory settings - Lower for dev
      MEMORY: "1G"
      MAX_MEMORY: "2G"
      
      # Server settings - Development friendly
      SERVER_NAME: "[DEV] Minecraft Server"
      MOTD: "§e[DEVELOPMENT] §fWelcome to the dev server!"
      DIFFICULTY: "peaceful"
      MODE: "creative"
      MAX_PLAYERS: "10"
      # ONLINE_MODE comes from .env.dev
      PVP: "false"
      VIEW_DISTANCE: "8"
      
      # World settings - Fast iteration
      LEVEL: "world-dev"
      SEED: ""
      ALLOW_NETHER: "true"
      ALLOW_FLIGHT: "true"
      ENABLE_COMMAND_BLOCK: "true"
      SPAWN_PROTECTION: "0"
      
      # Performance settings - Relaxed for dev
      MAX_TICK_TIME: "-1"  # Disable watchdog
      SPAWN_MONSTERS: "false"
      SPAWN_ANIMALS: "true"
      
      # RCON - Easy access for dev
      ENABLE_RCON: "true"
      RCON_PASSWORD: "devpass"
      RCON_PORT: "25575"
      
      # Development settings
      DEBUG: "true"
      LOG_LEVEL: "DEBUG"
      SYNC_SKIP_NEWER_IN_DESTINATION: "false"
      
      # Auto-pause when no players (saves resources)
      ENABLE_AUTOPAUSE: "true"
      AUTOPAUSE_TIMEOUT_EST: "60"
      AUTOPAUSE_TIMEOUT_INIT: "60"
      
      # Plugin settings are loaded from .env.dev via env_file directive
      # Only override base Minecraft server settings here
    
    volumes:
      # Separate dev data
      # :Z flag is required for SELinux (Fedora/RHEL) - sets private unshared label
      - ./data-dev:/data:Z
      
      # Datapacks, plugins, resourcepacks
      # :z flag for read-only shared volumes on SELinux systems
      - ./datapacks:/datapacks:ro,z
      - ./plugins:/plugins:ro,z
      - ./resourcepacks:/resourcepacks:ro,z
      - ./config:/config:ro,z
      
      # Dev logs
      - ./logs-dev:/data/logs:Z
    
    stdin_open: true
    tty: true
    
    # Health check for development
    healthcheck:
      test: ["CMD", "mc-health"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s
    
    networks:
      - minecraft-dev-network
    
    labels:
      - "environment=development"
      - "project=minecraft-server"

networks:
  minecraft-dev-network:
    driver: bridge
    name: minecraft-dev-network
