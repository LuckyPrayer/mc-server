FROM itzg/minecraft-server:latest

# Development Environment Configuration
ENV EULA=TRUE \
    TYPE=SPIGOT \
    VERSION=1.21.5 \
    MEMORY=1G \
    MAX_MEMORY=2G \
    SERVER_NAME="[DEV] Spigot 1.21.5" \
    DIFFICULTY=peaceful \
    MODE=creative \
    ALLOW_NETHER=true \
    ENABLE_COMMAND_BLOCK=true \
    MAX_PLAYERS=10 \
    ONLINE_MODE=false \
    PVP=false \
    VIEW_DISTANCE=8 \
    SPAWN_PROTECTION=0 \
    ENABLE_RCON=true \
    DEBUG=true \
    LOG_LEVEL=DEBUG
# Note: RCON_PASSWORD defaults to 'devpass' in docker-compose.dev.yml for convenience

# Development-specific settings
ENV MAX_TICK_TIME=-1 \
    SPAWN_MONSTERS=false \
    SPAWN_ANIMALS=true \
    ALLOW_FLIGHT=true

COPY --chown=minecraft:minecraft datapacks/ /datapacks/
COPY --chown=minecraft:minecraft plugins/ /plugins/
COPY --chown=minecraft:minecraft resourcepacks/ /resourcepacks/
COPY --chown=minecraft:minecraft config/ /config/

# Copy templates for runtime configuration generation
COPY --chown=minecraft:minecraft templates/ /templates/

# Copy default environment variable files
COPY --chown=minecraft:minecraft defaults/ /defaults/

# Copy entrypoint script for template processing
COPY --chown=minecraft:minecraft scripts/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

LABEL environment="development" \
    maintainer="dev-team" \
    description="Spigot 1.21.5 - Development Build"

# Expose Minecraft server port and RCON
EXPOSE 25565 25575

# Use custom entrypoint for template processing
ENTRYPOINT ["/entrypoint.sh"]


# --- Server Icon Logic ---
# Copy local server-icon.png if present
ARG SERVER_ICON_URL=""
COPY scripts/add-server-icon.sh /tmp/add-server-icon.sh
COPY --chown=minecraft:minecraft server-icon.png* /tmp/
RUN bash /tmp/add-server-icon.sh "$SERVER_ICON_URL"

# The base image handles the rest of the setup
